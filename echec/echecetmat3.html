<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puzzles √âchec & Mat ‚â§3 (PC FIX)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        font-family: Arial;
        display: flex;
        background: #ddd;
        margin: 0;
        padding: 0;
    }

    #boardContainer {
        margin: 20px;
    }

    #board {
        width: 560px;
        height: 560px;
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        grid-template-rows: repeat(8, 1fr);
        border: 2px solid black;
    }

    .case {
        position: relative;
        display:flex;
        justify-content:center;
        align-items:center;
    }

    .clair { background:#f0d9b5; }
    .fonce { background:#b58863; }

    .case.selected {
        outline: 4px solid red;
        box-sizing: border-box;
    }

    .piece {
        width:65px;
        height:65px;
        pointer-events:none;
    }

    #side {
        background:white;
        padding:20px;
        width:320px;
        height:100vh;
        overflow-y:auto;
        box-shadow: -4px 0 10px rgba(0,0,0,0.2);
    }

    button {
        padding:10px;
        width:100%;
        margin-bottom:10px;
        font-size:16px;
    }

    #status, #hintBox, #solutionBox, #movesBox {
        background:#fff;
        border:1px solid #aaa;
        padding:10px;
        margin-top:10px;
        white-space:pre-wrap;
    }
</style>
</head>

<body>

<div id="boardContainer">
    <div id="board"></div>
</div>

<div id="side">
    <button id="newPuzzleBtn">‚ú® Nouveau puzzle</button>
    <button id="undoBtn">‚Ü©Ô∏è Annuler</button>
    <button id="hintBtn">üí° Indice</button>
    <button id="solutionBtn">üìò Solution</button>

    <div id="status">Chargement moteur‚Ä¶</div>
    <div id="hintBox" style="display:none"></div>
    <div id="solutionBox" style="display:none"></div>
    <div id="movesBox"></div>
</div>

<script>
// -------------------------------
//   D√âCLARATIONS
// -------------------------------

const files = ["a","b","c","d","e","f","g","h"];

const piecesImg = {
    "wK": "chess/wK.png",
    "wQ": "chess/wQ.png",
    "wR": "chess/wR.png",
    "wB": "chess/wB.png",
    "wN": "chess/wN.png",
    "wP": "chess/wP.png",

    "bK": "chess/bK.png",
    "bQ": "chess/bQ.png",
    "bR": "chess/bR.png",
    "bB": "chess/bB.png",
    "bN": "chess/bN.png",
    "bP": "chess/bP.png"
};

let position = {};
let sideToMove = "w";
let selectedSquare = null;
let history = [];
let moves = [];
let hintLevel = 0;

let engine = null;
let engineReady = false;
let engineMode = null;
let generatorResolve = null;
let generatorInfo = null;
let solutionInfo = { pv:"", scoreCp:null, mate:null, depth:null };

const board = document.getElementById("board");
const statusDiv = document.getElementById("status");
const movesBox = document.getElementById("movesBox");
const hintBox = document.getElementById("hintBox");
const solutionBox = document.getElementById("solutionBox");

// -------------------------------
//     AFFICHAGE DU PLATEAU
// -------------------------------

function renderBoard() {
    board.innerHTML = "";
    for (let r = 8; r >= 1; r--) {
        for (let f = 0; f < 8; f++) {
            const sq = files[f] + r;
            const div = document.createElement("div");
            div.id = sq;
            div.className = "case " + ((r+f)%2 ? "fonce" : "clair");
            div.addEventListener("click", ()=>onClickSquare(sq));
            board.appendChild(div);
        }
    }
}

function refreshBoard() {
    renderBoard();
    for (let sq in position) {
        if (!position[sq]) continue;
        const img = document.createElement("img");
        img.src = piecesImg[position[sq]];
        img.className = "piece";
        document.getElementById(sq).appendChild(img);
    }
    if (selectedSquare) {
        document.getElementById(selectedSquare).classList.add("selected");
    }
}

// -------------------------------
//   POSITION PAR D√âFAUT (FIX)
// -------------------------------
// üëâ Ceci garantit que des pi√®ces apparaissent d√®s l‚Äôouverture

function loadDefaultPosition() {
    position = {
        "a2":"wP","b2":"wP","c2":"wP","d2":"wP","e2":"wP","f2":"wP","g2":"wP","h2":"wP",
        "a7":"bP","b7":"bP","c7":"bP","d7":"bP","e7":"bP","f7":"bP","g7":"bP","h7":"bP",
        "e1":"wK","e8":"bK"
    };
    sideToMove = "w";
    refreshBoard();
}

// -------------------------------
//       MOTEUR STOCKFISH
// -------------------------------

async function createEngine() {
    const file = await fetch("https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js");
    const txt = await file.text();
    return new Worker(URL.createObjectURL(new Blob([txt], {type:"application/javascript"})));
}

(async ()=>{
    engine = await createEngine();

    engine.onmessage = e => {
        const line = e.data;
        if (typeof line !== "string") return;

        if (line.includes("uciok")) {
            engineReady = true;
            statusDiv.textContent = "Moteur pr√™t.";
            return;
        }

        if (engineMode === "opponent" && line.startsWith("bestmove")) {
            const best = line.split(" ")[1];
            if (!best || best === "(none)" || best === "0000") {
                alert("üéâ Victoire !");
                return;
            }
            applyEngineMove(best);
            engineMode = null;
        }

        if (engineMode === "generator") {
            if (line.startsWith("info")) parseInfo(line, generatorInfo);
            else if (line.startsWith("bestmove")) {
                const r = generatorResolve;
                generatorResolve = null;
                engineMode = null;
                if (!r) return;

                if (generatorInfo.mate !== null && Math.abs(generatorInfo.mate) <= 3)
                    r(generatorInfo);
                else r(null);
            }
        }

        if (engineMode === "solution") {
            if (line.startsWith("info")) parseInfo(line, solutionInfo);
            else if (line.startsWith("bestmove")) {
                showSolutionFromInfo();
                engineMode = null;
            }
        }
    };

    engine.postMessage("uci");
})();

// -------------------------------
//      GESTION DES COUPS
// -------------------------------

function onClickSquare(sq) {
    document.querySelectorAll(".case").forEach(e=>e.classList.remove("selected"));

    if (!selectedSquare) {
        if (position[sq]) {
            selectedSquare = sq;
            document.getElementById(sq).classList.add("selected");
        }
        return;
    }

    if (sq !== selectedSquare)
        playerMove(selectedSquare, sq);

    selectedSquare = null;
}

function playerMove(from, to) {
    if (!position[from]) return;

    history.push({ position: JSON.parse(JSON.stringify(position)), sideToMove, moves: JSON.parse(JSON.stringify(moves)) });

    const piece = position[from];
    delete position[from];
    position[to] = piece;

    moves.push({ side: sideToMove, uci: from + to });
    sideToMove = sideToMove === "w" ? "b" : "w";

    refreshBoard();
    updateMoves();

    if (engineReady) engineReply();
}

function engineReply() {
    engineMode = "opponent";
    engine.postMessage("stop");
    engine.postMessage("position fen " + toFEN());
    engine.postMessage("go depth 10");
}

function applyEngineMove(uci) {
    const from = uci.slice(0,2);
    const to   = uci.slice(2,4);

    if (!position[from]) return;

    history.push({ position: JSON.parse(JSON.stringify(position)), sideToMove, moves: JSON.parse(JSON.stringify(moves)) });

    const piece = position[from];
    delete position[from];
    position[to] = piece;

    moves.push({ side: sideToMove, uci });
    sideToMove = sideToMove === "w" ? "b" : "w";

    refreshBoard();
    updateMoves();
}

// -------------------------------
//      AFFICHAGE DES COUPS
// -------------------------------

function updateMoves() {
    let txt = "";
    let num = 1;

    for (let i = 0; i < moves.length; i += 2) {
        txt += num + ". " + moves[i].uci;
        if (moves[i+1]) txt += "  " + moves[i+1].uci;
        txt += "\n";
        num++;
    }

    movesBox.textContent = txt;
}

// -------------------------------
//        FEN
// -------------------------------

function toFEN() {
    let fen = "";
    for (let r = 8; r >= 1; r--) {
        let empty = 0;
        for (let f = 0; f < 8; f++) {
            const sq = files[f] + r;
            const p = position[sq];
            if (!p) empty++;
            else {
                if (empty) { fen += empty; empty = 0; }
                fen += p[0] === "w" ? p[1] : p[1].toLowerCase();
            }
        }
        if (empty) fen += empty;
        if (r > 1) fen += "/";
    }
    return fen + " " + sideToMove + " - - 0 1";
}

// -------------------------------
//       PUZZLES (G√âN√âRATION)
// -------------------------------

function parseInfo(line, target) {
    const parts = line.split(" ");

    const depthIdx = parts.indexOf("depth");
    if (depthIdx !== -1) target.depth = parseInt(parts[depthIdx+1]);

    const scoreIdx = parts.indexOf("score");
    if (scoreIdx !== -1) {
        if (parts[scoreIdx+1] === "mate") {
            target.mate = parseInt(parts[scoreIdx+2]);
            target.scoreCp = null;
        } else {
            target.scoreCp = parseInt(parts[scoreIdx+2]);
            target.mate = null;
        }
    }

    const pvIdx = parts.indexOf("pv");
    if (pvIdx !== -1) {
        target.pv = parts.slice(pvIdx+1).join(" ");
    }
}

async function analyseFen(fen) {
    return new Promise(res=>{
        generatorInfo = {pv:"", scoreCp:null, mate:null, depth:null};
        generatorResolve = res;
        engineMode = "generator";
        engine.postMessage("stop");
        engine.postMessage("position fen "+fen);
        engine.postMessage("go depth 12");
    });
}

function randomPos() {
    const board = {};
    const squares = [];
    for (let r=1;r<=8;r++) for (let f of files) squares.push(f+r);

    // place rois
    const wk = squares.splice(Math.floor(Math.random()*squares.length),1)[0];
    const bk = squares.splice(Math.floor(Math.random()*squares.length),1)[0];

    board[wk] = "wK";
    board[bk] = "bK";

    const types = ["Q","R","B","N","P"];
    for (let i=0;i<4;i++) {
        const sq = squares.splice(Math.floor(Math.random()*squares.length),1)[0];
        board[sq] = "w" + types[Math.floor(Math.random()*types.length)];
    }

    return board;
}

function positionObjToFEN(obj, trait) {
    let fen = "";
    for (let r=8;r>=1;r--) {
        let empty = 0;
        for (let f=0;f<8;f++) {
            const sq = files[f]+r;
            const p = obj[sq];
            if (!p) empty++;
            else {
                if (empty) { fen+=empty; empty=0; }
                fen += p[0]==="w" ? p[1] : p[1].toLowerCase();
            }
        }
        if (empty) fen+=empty;
        if (r>1) fen+="/";
    }
    return fen+" "+trait+" - - 0 1";
}

async function newPuzzle() {
    statusDiv.textContent = "Recherche puzzle...";
    hintBox.style.display = "none";
    solutionBox.style.display = "none";

    for (let i=0;i<40;i++) {
        sideToMove = "w";
        const pos = randomPos();
        const fen = positionObjToFEN(pos, "w");

        const res = await analyseFen(fen);

        if (res && res.mate !== null && res.mate > 0 && Math.abs(res.mate) <= 3) {
            position = pos;
            refreshBoard();
            updateMoves();
            statusDiv.textContent = "Puzzle trouv√© : mat en " + Math.abs(res.mate);
            return;
        }
    }

    statusDiv.textContent = "Impossible de g√©n√©rer un puzzle.";
}

// -------------------------------
//       INDICES & SOLUTION
// -------------------------------

document.getElementById("hintBtn").onclick = ()=>{
    const hints = [
        "Cherche un √©chec forc√©.",
        "Regarde les cases de fuite du roi adverse.",
        "Peut-√™tre un sacrifice ?"
    ];
    hintBox.textContent = "Indice : " + hints[hintLevel % hints.length];
    hintBox.style.display = "block";
    hintLevel++;
};

function showSolutionFromInfo() {
    let t = "Ligne : " + solutionInfo.pv + "\n\n";

    if (solutionInfo.mate !== null)
        t += "Mat en " + Math.abs(solutionInfo.mate) + "\n";
    else if (solutionInfo.scoreCp !== null)
        t += "√âvaluation : " + (solutionInfo.scoreCp/100).toFixed(2) + "\n";

    t += "Profondeur : " + solutionInfo.depth;

    solutionBox.textContent = t;
    solutionBox.style.display = "block";
}

document.getElementById("solutionBtn").onclick = ()=>{
    solutionInfo = { pv:"", scoreCp:null, mate:null, depth:null };
    engineMode = "solution";
    engine.postMessage("stop");
    engine.postMessage("position fen "+toFEN());
    engine.postMessage("go depth 14");
};

// -------------------------------
//          ANNULER
// -------------------------------

document.getElementById("undoBtn").onclick = ()=>{
    if (!history.length) return;
    const h = history.pop();
    position = h.position;
    sideToMove = h.sideToMove;
    moves = h.moves;
    refreshBoard();
    updateMoves();
};

// -------------------------------
//          BOUTON PUZZLE
// -------------------------------

document.getElementById("newPuzzleBtn").onclick = ()=>newPuzzle();

// -------------------------------
//   INITIALISATION
// -------------------------------

renderBoard();
loadDefaultPosition(); // <-- FIX : affiche des pi√®ces imm√©diatement
statusDiv.textContent = "Moteur en cours de chargement‚Ä¶";

</script>

</body>
</html>
