<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Puzzles √âchec & Mat ‚â§3 ‚Äì MOBILE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        margin: 0;
        padding: 0;
        background: #e5e5e5;
        font-family: Arial;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #board {
        width: 92vw;
        max-width: 420px;
        height: 92vw;
        max-height: 420px;

        display: grid;
        grid-template-columns: repeat(8,1fr);
        grid-template-rows: repeat(8,1fr);
        border: 2px solid black;
        margin-top: 15px;
        border-radius: 6px;
        overflow: hidden;
    }

    .case {
        display:flex;
        justify-content:center;
        align-items:center;
    }

    .clair { background:#f0d9b5; }
    .fonce { background:#b58863; }

    .selected {
        outline: 3px solid red;
    }

    .piece {
        width: calc(92vw / 8 - 4px);
        max-width: 50px;
        height: auto;
        pointer-events:none;
    }

    #controls {
        margin-top: 15px;
        width: 92vw;
        max-width: 420px;
    }

    button {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        font-size: 17px;
        font-weight: 600;
        border-radius: 8px;
        border: 1px solid #666;
        background: white;
    }

    #status, #hintBox, #solutionBox {
        background:white;
        border:1px solid #bbb;
        padding:10px;
        margin-top:10px;
        border-radius:6px;
        white-space:pre-wrap;
        font-size:15px;
    }
</style>
</head>

<body>

<div id="board"></div>

<div id="controls">
    <button id="newPuzzleBtn">‚ú® Nouveau puzzle</button>
    <button id="undoBtn">‚Ü©Ô∏è Annuler</button>
    <button id="hintBtn">üí° Indice</button>
    <button id="solutionBtn">üìò Solution</button>

    <div id="status">Chargement moteur‚Ä¶</div>
    <div id="hintBox" style="display:none"></div>
    <div id="solutionBox" style="display:none"></div>
</div>

<script>
// ------------------------------
// VARIABLES
// ------------------------------

const files = ["a","b","c","d","e","f","g","h"];
const board = document.getElementById("board");

const piecesImg = {
    "wK": "chess/wK.png",
    "wQ": "chess/wQ.png",
    "wR": "chess/wR.png",
    "wB": "chess/wB.png",
    "wN": "chess/wN.png",
    "wP": "chess/wP.png",

    "bK": "chess/bK.png",
    "bQ": "chess/bQ.png",
    "bR": "chess/bR.png",
    "bB": "chess/bB.png",
    "bN": "chess/bN.png",
    "bP": "chess/bP.png"
};

let position = {};
let sideToMove = "w";
let selectedSquare = null;
let history = [];
let moves = [];

let engine = null;
let engineReady = false;

let engineMode = null;
let generatorResolve = null;
let generatorInfo = null;
let solutionInfo = {pv:"", scoreCp:null, mate:null, depth:null};

const statusDiv = document.getElementById("status");
const hintBox = document.getElementById("hintBox");
const solutionBox = document.getElementById("solutionBox");

// ------------------------------
// AFFICHAGE DU PLATEAU
// ------------------------------

function renderBoard() {
    board.innerHTML = "";
    for (let r = 8; r >= 1; r--) {
        for (let f = 0; f < 8; f++) {
            const sq = files[f] + r;
            const d = document.createElement("div");
            d.id = sq;
            d.className = "case " + ((r+f)%2 ? "fonce" : "clair");
            d.addEventListener("click", ()=>onClickSquare(sq));
            board.appendChild(d);
        }
    }
}

function refreshBoard() {
    renderBoard();
    for (let sq in position) {
        const p = position[sq];
        if (!p) continue;
        const img = document.createElement("img");
        img.src = piecesImg[p];
        img.className = "piece";
        document.getElementById(sq).appendChild(img);
    }
    if (selectedSquare)
        document.getElementById(selectedSquare).classList.add("selected");
}

// ------------------------------
//   POSITION PAR D√âFAUT = FIX
// ------------------------------

function loadDefaultPosition() {
    position = {
        "a2":"wP","b2":"wP","c2":"wP","d2":"wP","e2":"wP","f2":"wP","g2":"wP","h2":"wP",
        "a7":"bP","b7":"bP","c7":"bP","d7":"bP","e7":"bP","f7":"bP","g7":"bP","h7":"bP",
        "e1":"wK","e8":"bK"
    };
    sideToMove = "w";
    refreshBoard();
}

// ------------------------------
// STOCKFISH
// ------------------------------

async function createEngine() {
    const file = await fetch("https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js");
    return new Worker(URL.createObjectURL(await file.blob()));
}

(async ()=>{
    engine = await createEngine();

    engine.onmessage = e => {
        const line = e.data;
        if (typeof line !== "string") return;

        if (line.includes("uciok")) {
            engineReady = true;
            statusDiv.textContent = "Moteur pr√™t.";
            return;
        }

        if (engineMode === "generator") {
            if (line.startsWith("info")) parseInfo(line, generatorInfo);
            else if (line.startsWith("bestmove")) finishGenerator();
        }

        if (engineMode === "solution") {
            if (line.startsWith("info")) parseInfo(line, solutionInfo);
            else if (line.startsWith("bestmove")) showSolutionText();
        }
    };

    engine.postMessage("uci");
})();

// ------------------------------
// FEN & G√âN√âRATION
// ------------------------------

function positionObjToFEN(obj, trait) {
    let fen = "";
    for (let r=8;r>=1;r--) {
        let empty = 0;
        for (let f=0;f<8;f++) {
            const sq = files[f]+r;
            const p = obj[sq];
            if (!p) empty++;
            else {
                if (empty){fen+=empty; empty=0;}
                fen += p[0]=="w" ? p[1] : p[1].toLowerCase();
            }
        }
        if (empty) fen+=empty;
        if (r>1) fen += "/";
    }
    return fen+" "+trait+" - - 0 1";
}

function parseInfo(line, target) {
    const parts = line.split(" ");

    let i = parts.indexOf("depth");
    if (i !== -1) target.depth = parseInt(parts[i+1]);

    i = parts.indexOf("score");
    if (i !== -1) {
        if (parts[i+1]==="mate") {
            target.mate = parseInt(parts[i+2]);
            target.scoreCp = null;
        } else {
            target.mate = null;
            target.scoreCp = parseInt(parts[i+2]);
        }
    }

    i = parts.indexOf("pv");
    if (i !== -1) target.pv = parts.slice(i+1).join(" ");
}

async function analyseFen(fen) {
    return new Promise(res=>{
        generatorInfo = {pv:"", scoreCp:null, mate:null, depth:null};
        generatorResolve = res;
        engineMode = "generator";
        engine.postMessage("stop");
        engine.postMessage("position fen "+fen);
        engine.postMessage("go depth 12");
    });
}

function randomPos() {
    const sqs = [];
    for (let r=1;r<=8;r++) for (let f of files) sqs.push(f+r);

    const pos = {};

    const wk = sqs.splice(Math.random()*sqs.length|0,1)[0];
    pos[wk]="wK";

    const bk = sqs.splice(Math.random()*sqs.length|0,1)[0];
    pos[bk]="bK";

    const types=["Q","R","B","N","P"];
    for (let i=0;i<4;i++){
        const sq = sqs.splice(Math.random()*sqs.length|0,1)[0];
        pos[sq]="w"+types[(Math.random()*5)|0];
    }

    return pos;
}

function finishGenerator() {
    const r = generatorResolve;
    generatorResolve = null;
    engineMode = null;

    if (!r) return;

    if (generatorInfo.mate !== null && generatorInfo.mate > 0 && Math.abs(generatorInfo.mate) <= 3)
        r(generatorInfo);
    else r(null);
}

async function newPuzzle() {
    statusDiv.textContent = "Recherche puzzle‚Ä¶";
    hintBox.style.display = "none";
    solutionBox.style.display = "none";

    for (let i=0;i<40;i++) {
        sideToMove="w";
        const pos = randomPos();
        const fen = positionObjToFEN(pos,"w");
        const res = await analyseFen(fen);

        if (res && res.mate !== null && res.mate>0 && Math.abs(res.mate)<=3) {
            position = pos;
            refreshBoard();
            statusDiv.textContent = "Puzzle : mat en "+Math.abs(res.mate);
            return;
        }
    }

    statusDiv.textContent = "Aucun puzzle trouv√© üòï";
}

// ------------------------------
// INDICES & SOLUTION
// ------------------------------

document.getElementById("hintBtn").onclick = ()=>{
    const hints = [
        "Cherche un √©chec.",
        "Regarde les cases de fuite.",
        "Peut-√™tre un sacrifice ?"
    ];
    hintBox.textContent = hints[Math.floor(Math.random()*hints.length)];
    hintBox.style.display="block";
};

document.getElementById("solutionBtn").onclick = ()=>{
    solutionInfo = {pv:"", scoreCp:null, mate:null, depth:null};
    engineMode = "solution";
    engine.postMessage("stop");
    engine.postMessage("position fen "+positionObjToFEN(position,sideToMove));
    engine.postMessage("go depth 14");
};

function showSolutionText() {
    let t = "Ligne : "+solutionInfo.pv+"\n";
    if (solutionInfo.mate!==null)
        t+="Mat en "+Math.abs(solutionInfo.mate)+"\n";
    else if (solutionInfo.scoreCp!==null)
        t+="√âvaluation : "+(solutionInfo.scoreCp/100).toFixed(2)+"\n";
    t+="Profondeur : "+solutionInfo.depth;
    solutionBox.textContent = t;
    solutionBox.style.display="block";
}

// ------------------------------
// COUPS & ANNULER
// ------------------------------

document.getElementById("undoBtn").onclick = ()=>{
    if (!history.length) return;
    const h = history.pop();
    position = h.position;
    sideToMove = h.sideToMove;
    moves = h.moves;
    refreshBoard();
};

// ------------------------------
// CLIQUES DU PLATEAU
// ------------------------------

function onClickSquare(sq) {
    document.querySelectorAll(".case").forEach(e=>e.classList.remove("selected"));

    if (!selectedSquare) {
        if (position[sq]) {
            selectedSquare=sq;
            document.getElementById(sq).classList.add("selected");
        }
        return;
    }

    if (sq !== selectedSquare)
        playMove(selectedSquare,sq);

    selectedSquare=null;
}

function playMove(from,to) {
    if (!position[from]) return;

    history.push({position: JSON.parse(JSON.stringify(position)), sideToMove});

    const p = position[from];
    delete position[from];
    position[to] = p;

    sideToMove = sideToMove==="w" ? "b" : "w";

    refreshBoard();
}

// ------------------------------
// LANCEMENT
// ------------------------------

renderBoard();
loadDefaultPosition();

document.getElementById("newPuzzleBtn").onclick = ()=>newPuzzle();

</script>

</body>
</html>
